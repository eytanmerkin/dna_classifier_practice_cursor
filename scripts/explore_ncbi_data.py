"""
Explore NCBI data sources for additional DNA sequence data.

This script researches available NCBI databases and APIs for accessing
gene sequences with GeneType annotations.
"""

import os
import json
from datetime import datetime

OUTPUT_DIR = "analysis_output"
REPORT_FILE = os.path.join(OUTPUT_DIR, "ncbi_data_sources.md")


def generate_ncbi_report():
    """Generate a comprehensive report on NCBI data sources."""
    
    report_lines = [
        "# NCBI Data Sources Research Report",
        "",
        f"**Generated**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
        "",
        "## Overview",
        "",
        "This report documents available NCBI databases and APIs for accessing",
        "DNA sequence data with gene type annotations.",
        "",
        "## NCBI Databases",
        "",
        "### 1. NCBI Gene Database",
        "",
        "**Description**: Comprehensive database of gene-specific information.",
        "",
        "**Access Methods**:",
        "- **Entrez API**: Programmatic access via `biopython.Entrez`",
        "- **Web Interface**: https://www.ncbi.nlm.nih.gov/gene",
        "- **FTP**: Bulk downloads available",
        "",
        "**Data Available**:",
        "- Gene IDs (NCBI Gene ID)",
        "- Gene symbols and aliases",
        "- Gene type annotations (protein-coding, ncRNA, pseudogene, etc.)",
        "- Genomic locations",
        "- Sequence data (via linked RefSeq/GenBank entries)",
        "",
        "**API Endpoints**:",
        "- `esearch`: Search for gene IDs",
        "- `esummary`: Get gene summaries",
        "- `efetch`: Retrieve full gene records",
        "",
        "### 2. RefSeq Database",
        "",
        "**Description**: Curated, non-redundant reference sequences.",
        "",
        "**Access Methods**:",
        "- **NCBI Datasets CLI**: `ncbi-datasets` command-line tool",
        "- **Entrez API**: Via `biopython`",
        "- **FTP**: https://ftp.ncbi.nlm.nih.gov/refseq/",
        "",
        "**Data Available**:",
        "- Reference sequences with annotations",
        "- Gene type classifications",
        "- Sequence data in FASTA format",
        "",
        "**Advantages**:",
        "- High quality, curated data",
        "- Consistent annotation standards",
        "- Well-documented gene types",
        "",
        "### 3. GenBank",
        "",
        "**Description**: Comprehensive public sequence database.",
        "",
        "**Access Methods**:",
        "- **Entrez API**: Via `biopython.Entrez`",
        "- **FTP**: Bulk downloads",
        "",
        "**Data Available**:",
        "- Full sequence records",
        "- Gene annotations",
        "- Metadata (organism, assembly, etc.)",
        "",
        "**Note**: Larger but less curated than RefSeq.",
        "",
        "### 4. Gene Expression Omnibus (GEO)",
        "",
        "**Description**: Repository for gene expression data.",
        "",
        "**Relevance**: Less directly relevant for sequence classification,",
        "but may contain annotated sequences from experiments.",
        "",
        "## Recommended Tools & Libraries",
        "",
        "### 1. Biopython",
        "",
        "**Package**: `biopython`",
        "",
        "**Usage**:",
        "```python",
        "from Bio import Entrez",
        "from Bio import SeqIO",
        "",
        "Entrez.email = 'your.email@example.com'  # Required",
        "handle = Entrez.esearch(db='gene', term='ncRNA[Gene Type]')",
        "record = Entrez.read(handle)",
        "```",
        "",
        "**Advantages**:",
        "- Well-maintained Python library",
        "- Easy to use",
        "- Good documentation",
        "- Handles API rate limiting",
        "",
        "**Rate Limits**: 3 requests/second (NCBI policy)",
        "",
        "### 2. NCBI Datasets CLI",
        "",
        "**Package**: `ncbi-datasets`",
        "",
        "**Usage**:",
        "```bash",
        "pip install ncbi-datasets-cli",
        "datasets download gene --input-file gene_ids.txt",
        "```",
        "",
        "**Advantages**:",
        "- Official NCBI tool",
        "- Bulk downloads",
        "- Handles large datasets efficiently",
        "",
        "## Data Access Strategy",
        "",
        "### Recommended Approach",
        "",
        "1. **Use Biopython Entrez API** for programmatic queries:",
        "   - Search by gene type (e.g., 'ncRNA[Gene Type]')",
        "   - Filter by organism if needed",
        "   - Retrieve gene IDs and metadata",
        "",
        "2. **Fetch Sequences** via linked RefSeq/GenBank entries:",
        "   - Use gene IDs to get sequence accessions",
        "   - Download sequences in FASTA format",
        "   - Extract relevant sequence regions",
        "",
        "3. **Filter Criteria**:",
        "   - Sequence length: 2-1000 nucleotides (matching current data)",
        "   - Gene type: Focus on rare classes (scRNA, snRNA, rRNA)",
        "   - Quality: Prefer RefSeq over GenBank for consistency",
        "",
        "## Example Query Patterns",
        "",
        "### Search for ncRNA genes:",
        "```python",
        "term = 'ncRNA[Gene Type] AND Homo sapiens[Organism]'",
        "```",
        "",
        "### Search for specific gene types:",
        "```python",
        "term = '(snRNA[Gene Type] OR snoRNA[Gene Type]) AND human[Organism]'",
        "```",
        "",
        "### Search by gene ID (for validation):",
        "```python",
        "term = '123456[Gene ID]'",
        "```",
        "",
        "## Implementation Notes",
        "",
        "1. **Email Registration**: NCBI requires email for API access",
        "2. **Rate Limiting**: Implement delays (0.34 seconds between requests)",
        "3. **Error Handling**: NCBI API can be slow/unreliable, need retries",
        "4. **Data Format**: Ensure downloaded sequences match current format",
        "",
        "## Next Steps",
        "",
        "1. Install `biopython`: `pip install biopython`",
        "2. Set up NCBI API access with email",
        "3. Test queries on small subset",
        "4. Implement full data fetching script",
        ""
    ]
    
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    with open(REPORT_FILE, 'w') as f:
        f.write('\n'.join(report_lines))
    
    print(f"Report generated: {REPORT_FILE}")


if __name__ == "__main__":
    generate_ncbi_report()
